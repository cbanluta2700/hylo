# Data Model: AI-Powered Itinerary Generation

**Feature**: AI workflow that generates and displays itineraries based on user form data  
**Date**: 2025-09-23  
**Branch**: 001-create-a-ai

## Core Entities

### 1. WorkflowSession

**Purpose**: Tracks the complete AI workflow execution state  
**Lifecycle**: Created on generation start, updated during execution, expires after completion

```typescript
interface WorkflowSession {
  id: string; // UUID for tracking
  sessionId: string; // User session identifier
  requestId: string; // Individual generation request
  status: 'pending' | 'processing' | 'completed' | 'failed';
  currentStage: 'architect' | 'gatherer' | 'specialist' | 'formatter' | 'complete';
  progress: number; // 0-100 percentage
  completedSteps: string[];
  startedAt: Date;
  completedAt?: Date;
  errorMessage?: string;
  retryCount: number;
  formData: TravelFormData;
}
```

**Storage**: Upstash Redis with 1-hour expiration  
**Relationships**: Contains embedded TravelFormData, produces GeneratedItinerary

### 2. TravelFormData (Extended)

**Purpose**: Complete user input from all form sections  
**Source**: Aggregated from existing form components

```typescript
interface TravelFormData {
  // Trip Details
  location: string;
  departDate: string;
  returnDate?: string;
  flexibleDates: boolean;
  plannedDays?: number;
  adults: number;
  children: number;
  childrenAges?: number[];

  // Budget
  budget: number;
  currency: 'USD' | 'EUR' | 'GBP' | 'CAD' | 'AUD';
  flexibleBudget: boolean;
  budgetMode: 'total' | 'per-person';

  // Travel Style & Preferences
  travelStyleChoice: 'answer-questions' | 'skip-to-details' | 'not-selected';
  travelStyleAnswers: Record<string, any>;
  selectedGroups?: string[];
  customGroupText?: string;
  selectedInterests?: string[];
  customInterestsText?: string;
  selectedInclusions?: string[];
  customInclusionsText?: string;
  inclusionPreferences: Record<string, any>;

  // Experience Preferences
  travelExperience?: string[];
  tripVibes?: string[];
  customVibeText?: string;
  sampleDays?: string[];
  dinnerPreferences?: string[];

  // Contact
  tripNickname?: string;
  contactName?: string;
  contactEmail?: string;
}
```

**Validation**: Zod schema with cross-field validation  
**Relationships**: Input to WorkflowSession, processed by AI agents

### 3. AgentWorkflowData

**Purpose**: Individual AI agent processing state and results  
**Lifecycle**: Created per agent execution, stored for debugging and optimization

```typescript
interface AgentWorkflowData {
  workflowId: string;
  agentType: 'architect' | 'gatherer' | 'specialist' | 'formatter';
  status: 'pending' | 'processing' | 'completed' | 'failed';
  input: any; // Agent-specific input data
  output?: any; // Agent-specific results
  processingTime: number; // Milliseconds
  tokensUsed?: number;
  errorDetails?: string;
  retryAttempt: number;
  startedAt: Date;
  completedAt?: Date;
}
```

**Storage**: Upstash Redis with 24-hour retention for debugging  
**Relationships**: Part of WorkflowSession

### 4. GeneratedItinerary

**Purpose**: Final AI-generated travel plan with all recommendations  
**Lifecycle**: Created by formatter agent, displayed to user, optionally cached

```typescript
interface GeneratedItinerary {
  id: string;
  workflowId: string;
  sessionId: string;

  // Trip Overview
  destination: Destination;
  totalDays: number;
  totalBudget: number;
  currency: string;
  generatedAt: Date;

  // Daily Plans
  dayPlans: DayPlan[];

  // Additional Information
  travelTips: string[];
  localInsights: string[];
  weatherConsiderations?: string[];
  budgetBreakdown: BudgetBreakdown;

  // Metadata
  aiModelsUsed: string[];
  processingTime: number;
  generationVersion: string;
}
```

### 5. DayPlan (Enhanced)

**Purpose**: Individual day structure within the itinerary  
**Source**: Generated by AI agents based on preferences

```typescript
interface DayPlan {
  day: number;
  date: string;
  location: string;
  theme?: string; // Daily focus (culture, adventure, relaxation)

  // Time-based Activities
  morning?: Activity;
  afternoon?: Activity;
  evening?: Activity;

  // Essential Information
  meals: Meal[];
  accommodation?: Accommodation;
  transportation?: Transportation[];

  // Financial
  estimatedBudget: number;
  budgetBreakdown: Record<string, number>;

  // Practical
  weather?: WeatherInfo;
  tips: string[];
  bookingPriority?: 'high' | 'medium' | 'low';
}
```

### 6. Activity (AI-Enhanced)

**Purpose**: Specific recommended activities with AI-generated insights

```typescript
interface Activity {
  id: string;
  name: string;
  description: string;
  location: string;
  coordinates?: { lat: number; lng: number };

  // Timing
  duration: string; // "2-3 hours"
  bestTimeToVisit?: string;
  openingHours?: string;

  // Costs
  cost: number;
  costRange: 'free' | '$' | '$$' | '$$$' | '$$$$';
  additionalFees?: string[];

  // Booking
  bookingRequired: boolean;
  bookingUrl?: string;
  advanceBookingDays?: number;

  // Suitability
  type: string; // "museum", "outdoor", "cultural"
  ageAppropriate: string[]; // ["adult", "family", "kids"]
  physicalRequirement: 'low' | 'medium' | 'high';
  weatherDependent: boolean;

  // AI Insights
  aiRecommendationReason: string;
  alternativeOptions?: string[];
  tips: string[];
}
```

### 7. Accommodation (Travel-Optimized)

**Purpose**: AI-recommended lodging with travel-specific details

```typescript
interface Accommodation {
  name: string;
  type: 'hotel' | 'hostel' | 'apartment' | 'resort' | 'guesthouse';
  location: string;
  coordinates?: { lat: number; lng: number };

  // Pricing
  pricePerNight: number;
  totalCost: number;
  priceRange: '$' | '$$' | '$$$' | '$$$$';

  // Features
  amenities: string[];
  roomType?: string;
  starRating?: number;
  guestRating?: number;

  // Booking
  bookingUrl?: string;
  cancellationPolicy?: string;

  // AI Insights
  matchReason: string; // Why AI selected this option
  proximityBenefits: string[];
  alternativeOptions?: string[];
}
```

### 8. Meal (AI-Curated)

**Purpose**: Restaurant recommendations with dietary and preference matching

```typescript
interface Meal {
  type: 'breakfast' | 'lunch' | 'dinner' | 'snack' | 'street-food';
  restaurant: string;
  cuisine: string;
  location: string;
  coordinates?: { lat: number; lng: number };

  // Pricing
  priceRange: '$' | '$$' | '$$$' | '$$$$';
  averageCost: number;

  // Details
  specialties: string[];
  dietaryOptions: string[]; // vegan, vegetarian, gluten-free
  atmosphere: string; // casual, fine-dining, family-friendly

  // Practical
  reservationRequired: boolean;
  reservationUrl?: string;
  openingHours?: string;

  // AI Matching
  preferenceMatch: string[]; // Matched user preferences
  localSignificance?: string; // Cultural/local importance
  alternativeOptions?: string[];
}
```

## State Management

### Redis Key Structure

```
workflow:{workflowId} -> WorkflowSession (1h TTL)
workflow:{workflowId}:agent:{agentType} -> AgentWorkflowData (24h TTL)
session:{sessionId}:active -> workflowId (1h TTL)
itinerary:{itineraryId} -> GeneratedItinerary (7d TTL)
```

### State Transitions

```
WorkflowSession.status:
pending -> processing -> completed
                     -> failed (with retry)

AgentWorkflowData.status:
pending -> processing -> completed
                      -> failed (with retry)
```

## Validation Rules

1. **Form Data Validation**:

   - Location must be valid destination
   - Dates must be chronological and future
   - Budget must be positive and realistic for destination
   - Child ages must match children count

2. **Workflow Validation**:

   - Maximum 3 retries per agent
   - 30-second timeout per agent execution
   - Total workflow timeout of 5 minutes

3. **Itinerary Validation**:
   - Daily budgets must sum to total budget Â±20%
   - Activities must be geographically feasible
   - Time allocations must be realistic

## Performance Considerations

- **Caching**: Popular destinations cached for 24h
- **Pagination**: Large itineraries paginated by day
- **Compression**: JSON responses compressed
- **Streaming**: Progress updates via Server-Sent Events
- **Cleanup**: Automatic Redis key expiration
